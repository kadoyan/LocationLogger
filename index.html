<!doctype html>
<html lang="ja">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<title>ワンタップ位置記録</title>
	<style>
		:root {
			--bg: #0b1020;
			--fg: #e8f0ff;
			--muted: #aab3c5;
			--accent: #7cc4ff;
			--card: #111836;
			--danger: #ff6b6b;
		}

		html,
		body {
			height: 100%;
		}

		body {
			margin: 0;
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
			background: linear-gradient(180deg, #0b1020, #0f1633);
			color: var(--fg);
		}

		.wrap {
			max-width: 960px;
			margin-inline: auto;
			padding: 16px;
		}

		.card {
			background: var(--card);
			border: 1px solid #233056;
			border-radius: 16px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
		}

		.pad {
			padding: 16px;
		}

		.headline {
			display: flex;
			gap: 12px;
			align-items: center;
		}

		h1 {
			font-size: 20px;
			margin: 0
		}

		.muted {
			color: var(--muted)
		}

		.row {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			align-items: center
		}

		.grow {
			flex: 1 1 200px
		}

		button {
			appearance: none;
			border: 0;
			border-radius: 12px;
			padding: 14px 18px;
			font-weight: 700;
			font-size: 16px;
			cursor: pointer
		}

		.primary {
			background: var(--accent)
		}

		.ghost {
			background: transparent;
			color: var(--fg);
			border: 1px solid #2b3a66
		}

		.danger {
			background: var(--danger);
			color: #101
		}

		.tiny {
			font-size: 12px;
			opacity: .8
		}

		.grid {
			overflow: auto;
			border-top: 1px solid #2b3a66
		}

		table {
			border-collapse: collapse;
			width: 100%;
			min-width: 720px
		}

		th,
		td {
			border-bottom: 1px solid #233056;
			padding: 10px 8px;
			text-align: left;
			font-size: 14px
		}

		th {
			position: sticky;
			top: 0;
			background: #0f1730;
			z-index: 1
		}

		tr:hover td {
			background: #0d1430
		}

		input.memo {
			width: 100%;
			background: #0c132b;
			border: 1px solid #2b3a66;
			color: var(--fg);
			padding: 8px;
			border-radius: 8px;
			font-size: 14px
		}

		.badge {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 999px;
			background: #0b3557;
			border: 1px solid #2b3a66;
			color: #cbe6ff;
			font-size: 12px
		}

		.footer {
			padding: 12px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 12px;
			flex-wrap: wrap
		}

		a.link {
			color: #b9d9ff
		}
	</style>
</head>

<body>
	<div class="wrap">
		<div class="card">
			<div class="pad">
				<div class="headline">
					<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8L12 2Z" stroke="#7cc4ff" stroke-width="1.5" />
					</svg>
					<h1>ワンタップ位置記録</h1>
				</div>
				<p class="muted" id="status">ボタンを押すと、現在地と時刻を1件記録します（端末の位置情報許可が必要です）。</p>
				<div class="row" style="margin-top:8px">
					<button id="recordBtn" class="primary grow">📍 現在地を記録</button>
					<button id="exportBtn" class="ghost">CSV書き出し</button>
					<button id="shareBtn" class="ghost">共有（対応端末のみ）</button>
					<button id="clearBtn" class="danger">全消去</button>
				</div>
				<div class="row" style="margin-top:8px">
					<span class="tiny">保存先: ブラウザの <code>localStorage</code></span>
					<span class="tiny">高精度: <code>enableHighAccuracy=true</code> / タイムアウト10秒</span>
				</div>
			</div>
			<div class="grid" id="tableWrap">
				<table id="table">
					<thead>
						<tr>
							<th>#</th>
							<th>時刻</th>
							<th>緯度</th>
							<th>経度</th>
							<th>精度(m)</th>
							<th>メモ</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="tbody"></tbody>
				</table>
			</div>
			<div class="footer">
				<div class="muted tiny">
					<div>⚠️ iOSでは<strong>HTTPS</strong>配信が必要です（GitHub Pages等でOK）。</div>
					<div>位置情報はこの端末内にのみ保存されます。</div>
				</div>
				<div id="count" class="badge">0 件</div>
			</div>
		</div>
	</div>

	<script>
		(function () {
			const KEY = 'tap-geo-log.v1';
			/** @type {Array<{id:string, ts:number, lat:number, lng:number, acc:number|null, memo:string}>} */
			let rows = load();

			const $ = sel => document.querySelector(sel);
			const tbody = $('#tbody');
			const status = $('#status');
			const count = $('#count');
			const recordBtn = $('#recordBtn');
			const exportBtn = $('#exportBtn');
			const shareBtn = $('#shareBtn');
			const clearBtn = $('#clearBtn');

			function load() {
				try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
				catch (e) { console.error(e); return []; }
			}
			function persist() { localStorage.setItem(KEY, JSON.stringify(rows)); update(); }

			function formatTs(ts) {
				const d = new Date(ts);
				const pad = n => String(n).padStart(2, '0');
				const iso = d.toISOString(); // for CSV
				const jp = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
				return { jp, iso };
			}

			function update() {
				tbody.innerHTML = '';
				rows.forEach((r, i) => {
					const tr = document.createElement('tr');
					const t = formatTs(r.ts);
					tr.innerHTML = `
        <td>${i + 1}</td>
        <td><div>${t.jp}</div><div class="tiny muted">${t.iso}</div></td>
        <td>${r.lat.toFixed(6)}</td>
        <td>${r.lng.toFixed(6)}</td>
        <td>${r.acc == null ? '-' : r.acc.toFixed(1)}</td>
        <td>
          <input class="memo" type="text" placeholder="メモ…" value="${escapeHtml(r.memo || '')}" data-id="${r.id}" />
        </td>
        <td>
          <button class="ghost" data-del="${r.id}">削除</button>
        </td>`;
					tbody.appendChild(tr);
				});
				count.textContent = `${rows.length} 件`;
			}

			function escapeHtml(s) {
				return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c]));
			}

			async function record() {
				status.textContent = '測位中…（最大10秒）';
				recordBtn.disabled = true;
				try {
					const pos = await new Promise((resolve, reject) => {
						navigator.geolocation.getCurrentPosition(resolve, reject, {
							enableHighAccuracy: true,
							timeout: 10000,
							maximumAge: 0,
						});
					});
					const { latitude, longitude, accuracy } = pos.coords;
					const row = { id: crypto.randomUUID(), ts: Date.now(), lat: latitude, lng: longitude, acc: accuracy ?? null, memo: '' };
					rows.unshift(row);
					persist();
					status.innerHTML = `✅ 記録しました（緯度: ${latitude.toFixed(5)} / 経度: ${longitude.toFixed(5)} / 精度: ${accuracy ? accuracy.toFixed(0) + 'm' : '-'}）`;
				} catch (err) {
					console.error(err);
					let msg = '位置情報の取得に失敗しました。設定で許可されているか確認してください。';
					if (err && err.code === 1) msg = '位置情報の利用が許可されていません。Safariの設定から許可してください。';
					if (err && err.code === 2) msg = '位置情報を取得できませんでした（電波状況など）。';
					if (err && err.code === 3) msg = 'タイムアウトしました。空の下で再試行してください。';
					status.textContent = `⚠️ ${msg}`;
				} finally {
					recordBtn.disabled = false;
				}
			}

			function toCSV() {
				const header = ['id', 'timestamp_iso', 'timestamp_local', 'latitude', 'longitude', 'accuracy_m', 'memo'];
				const lines = [header.join(',')];
				rows.forEach(r => {
					const t = formatTs(r.ts);
					const csvMemo = (r.memo || '').replaceAll('"', '""');
					const row = [r.id, t.iso, t.jp, r.lat, r.lng, r.acc ?? '', `"${csvMemo}"`];
					lines.push(row.join(','));
				});
				return lines.join('\n');
			}

			function downloadCSV() {
				const csv = toCSV();
				const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); // add BOM for Excel/Japanese
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				const stamp = new Date().toISOString().replace(/[:.]/g, '-');
				a.href = url;
				a.download = `tap-geo-log-${stamp}.csv`;
				document.body.appendChild(a);
				a.click();
				setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
			}

			async function shareCSV() {
				if (!('share' in navigator) || !('canShare' in navigator)) {
					status.textContent = 'この端末はWeb Share APIに未対応です。CSV書き出しをお使いください。';
					return;
				}
				const csv = toCSV();
				const file = new File([csv], 'tap-geo-log.csv', { type: 'text/csv' });
				if (navigator.canShare && !navigator.canShare({ files: [file] })) {
					status.textContent = 'この端末ではファイル共有に対応していません。';
					return;
				}
				try {
					await navigator.share({ files: [file], title: '位置記録CSV', text: '位置記録のCSVを共有します。' });
					status.textContent = '共有を実行しました。';
				} catch (e) {
					if (e && e.name === 'AbortError') {
						status.textContent = '共有をキャンセルしました。';
					} else {
						status.textContent = '共有に失敗しました。CSV書き出しをご利用ください。';
					}
				}
			}

			function onTableInput(e) {
				const target = e.target;
				if (target.matches('input.memo')) {
					const id = target.getAttribute('data-id');
					const r = rows.find(x => x.id === id);
					if (r) { r.memo = target.value; persist(); }
				}
				if (target.matches('button[data-del]')) {
					const id = target.getAttribute('data-del');
					rows = rows.filter(x => x.id !== id);
					persist();
				}
			}

			function clearAll() {
				if (!rows.length) return;
				if (confirm('すべての記録を削除します。よろしいですか？')) {
					rows = []; persist();
					status.textContent = 'すべて削除しました。';
				}
			}

			recordBtn.addEventListener('click', () => {
				if (!('geolocation' in navigator)) {
					status.textContent = 'このブラウザは位置情報APIに対応していません。';
					return;
				}
				record();
			});
			exportBtn.addEventListener('click', downloadCSV);
			shareBtn.addEventListener('click', shareCSV);
			clearBtn.addEventListener('click', clearAll);
			$('#table').addEventListener('click', onTableInput);
			$('#table').addEventListener('input', onTableInput);

			update();
		})();
	</script>
</body>

</html>
